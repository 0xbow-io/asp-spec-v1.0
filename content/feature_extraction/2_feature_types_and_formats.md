# 4.2 Feature Types and Formats

Valuable and meaningful classification depends on the feature-extractor's ability to extract the required features.
To assist with this, the ASP system should define a set of features that are relevant to the classification process.

Features should be represented in a standardized & structured and verfiable format to ensure compatibility
across different components of the ASP system & facilitate interoperability with external systems.

## 4.2.1 JSON Schema for Feature Definition

Category Feature Schema is a [JSON Schema](https://www.learnjsonschema.com/2020-12/) document
that defines the features of a category, i.e:

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "tag:0xbow.io,2024:categories:AML_COMPLIANT",
  "title": "Record is AML Compliant",
  "type": "object",
  "properties": {
    "features": {
      "type": "object",
      "properties": {
        "OFAC_LIST_MEMBERSHIP": {
          "$id": "tag:0xbow.io,2024:categories:AML_COMPLIANT:features:OFAC_LIST_MEMBERSHIP",
          "type": "boolean",
          "default": "true"
        },
        "FATF_LIST_MEMBERSHIP": {
          "$id": "tag:0xbow.io,2024:categories:AML_COMPLIANT:features:FATF_LIST_MEMBERSHIP",
          "type": "boolean",
          "default": "true"
        },
        "TRANSACTION_AMOUNT": {
          "$id": "tag:0xbow.io,2024:categories:AML_COMPLIANT:features:TRANSACTION_AMOUNT",
          "type": "integer",
          "default": "1000"
        }
      },
      "required": [
        "OFAC_LIST_MEMBERSHIP",
        "FATF_LIST_MEMBERSHIP",
        "TRANSACTION_AMOUNT"
      ]
    }
  },
  "required": ["features"]
}
```

In the above example, the `AML_COMPLIANT` category has three features:

- `OFAC_LIST_MEMBERSHIP`
- `FATF_LIST_MEMBERSHIP`
- `TRANSACTION_AMOUNT`

This schema can be translated into a data structure which can be
validated against the schema, i.e.:

```go
// As a struct
// with custom tags
type AML_COMPLIANT_CATEGORY truct {
	_ struct{} `id:"0xbow.io,2024"`
	_ struct{} `category:"AML_COMPLIANT"`
	OFAC_LIST_MEMBERSHIP boolean `feature:"OFAC_LIST_MEMBERSHIP" default:"true"`
	FATF_LIST_MEMBERSHIP boolean `feature:"FATF_LIST_MEMBERSHIP" default:"true"`
	TRANSACTION_AMOUNT integer `feature:"TRANSACTION_AMOUNT" default:"1000"`
}
```

### 4.2.1.1 Generating Category Feature Schema:

JSON Schema's like the one above can be Generated by a schema generator.
Below is an example walkthrough in creating a schema generater in go using the
[swaggest/jsonschema-go]("github.com/swaggest/jsonschema-go") package:

**(a) Declaring the interfaces for Features:**

```go
package feature

import (
	"github.com/swaggest/jsonschema-go"
)

type FeatureType struct {
	*jsonschema.Type
}

type Feature interface {
	T() FeatureType
	String() string
	Attributes() []interface{}
	Schema(idPrefix string) *jsonschema.Schema
}

type FeatureAttribute interface {
	String() string
	TagType() string
	Tag(string) string
}


```

**(b) Declaring Feature Schema for a Category:**

```go
package amlCompliantCat

import (
	"fmt"

	. "github.com/0xbow-io/asp-spec-V1.0/pkg/feature"
	"github.com/swaggest/jsonschema-go"
)

type _Feature uint

const (
	OFAC_LIST_MEMBERSHIP _Feature = iota
	FATF_LIST_MEMBERSHIP
	TRANSACTION_AMOUNT
)

var _ Feature = (*_Feature)(nil)


func (f _Feature) T() FeatureType {
	switch f {
	case OFAC_LIST_MEMBERSHIP:
		return FeatureType{
			Type: new(jsonschema.Type).WithSimpleTypes(jsonschema.Boolean),
		}
	case FATF_LIST_MEMBERSHIP:
		return FeatureType{
			Type: new(jsonschema.Type).WithSimpleTypes(jsonschema.Boolean),
		}
	case TRANSACTION_AMOUNT:
		return FeatureType{
			Type: new(jsonschema.Type).WithSimpleTypes(jsonschema.Number),
		}
	}
	return FeatureType{Type: new(jsonschema.Type)}
}


func (f _Feature) Feature() Feature {
	return &f
}

func (f _Feature) String() string {
	return [...]string{
		"OFAC_LIST_MEMBERSHIP",
		"FATF_LIST_MEMBERSHIP",
		"TRANSACTION_AMOUNT",
	}[f]
}

func (f _Feature) Attributes() []interface{} {
	return [...][]interface{}{
		// OFAC_LIST_MEMBERSHIP
		{
			required: "true",
			_default: true,
		},
		// FATF_LIST_MEMBERSHIP
		{
			required: "true",
			_default: true,
		},
		// "TRANSACTION_AMOUNT"
		{
			required: "true",
			_default: true,
		},
	}[f]
}

func (f _Feature) Schema(idPrefix string) (schema *jsonschema.Schema) {
	id := fmt.Sprintf("%s:features:%s", idPrefix, f.String())
	schema = &jsonschema.Schema{
		ID:   &id,
		Type: f.T().Type,
	}

	_attributes := f.Attributes()
	schema.WithDefault(_attributes[_default])
	schema.WithExamples(_attributes[examples])
	schema.WithPattern(_attributes[pattern].(string))
	schema.WithMaximum(_attributes[maximum].(float64))
	schema.WithExclusiveMaximum(_attributes[exclusiveMaximum].(float64))
	schema.WithMinimum(_attributes[minimum].(float64))

	return
}


```

**(c) Schema Generator:**

```go
package amlCompliantCat

import (
	"encoding/json"

	. "github.com/0xbow-io/asp-spec-V1.0/pkg/feature"
	"github.com/swaggest/jsonschema-go"
)

type CategorySchema struct {
	*jsonschema.Schema
}

func (s *CategorySchema) MarshalJSON() ([]byte, error) {
	return json.MarshalIndent(s.Schema, "", " ")
}

func (s *CategorySchema) applyFeatures(features []Feature) {
	for i, feature := range features {
		// add the feature schema to the array
		s.Schema.Properties["features"].TypeObject.Properties[feature.String()] = jsonschema.SchemaOrBool{
			TypeObject: feature.Schema(*s.Schema.ID),
		}
		s.Schema.Properties["features"].TypeObject.Required[i] = feature.String()
	}
}

func (s *CategorySchema) Generate(
	label,
	title string,
	features []Feature) CategorySchema {s
	id := fmt.Sprintf("0xbow.io,2024:categories:%s", label)
	s = &CategorySchema{
		Schema: &jsonschema.Schema{
			ID:    &id,
			Title: &title,
			Properties: map[string]jsonschema.SchemaOrBool{
				// category - feature schema
				"features": {
					TypeObject: &jsonschema.Schema{
						Required:   make([]string, len(features)),
						Type:       new(jsonschema.Type).WithSimpleTypes(jsonschema.Object),
						Properties: make(map[string]jsonschema.SchemaOrBool),
					},
				},
			},
		},
	}
	defer s.applyFeatures(features)
	return *s
}

```

**(d) Defining the Schema for AML_COMPLIANT category:**

```go
package amlCompliantCat

import (
	. "github.com/0xbow-io/asp-spec-V1.0/pkg/category"
	. "github.com/0xbow-io/asp-spec-V1.0/pkg/feature"
	"github.com/swaggest/jsonschema-go"
)

type _CategorySchema interface {
	MarshalJSON() ([]byte, error)
	Generate(label, title string, features []jsonschema.Field) *CategorySchema
}


var AML_COMPLIANT = new(CategorySchema).Generate(
	// Label
	"AML_COMPLIANT",
	// title
	"Record is AML Compliant",
	// Required Features
	[]Feature{
		Feature(OFAC_LIST_MEMBERSHIP),
		Feature(FATF_LIST_MEMBERSHIP),
		Feature(TRANSACTION_AMOUNT),
	})

```
